# 结题报告

## 项目名称 

面向RISC-V的RT-Thread系统

**项目编号**:2023112

## 方案描述

### 已有组件与利用方式

当前RT-Thread主线中已有部分MCU核心RISC-V处理器基本支持，可为QEMU中的实现提供接口实现参考。当前QEMU主线中RISC-V64 virt机型有较为完善的功能实现（MMU、Supervisor态、Atomic指令子集），可作为适配的机型。已有开源的uboot软件包对上述virt机型作出适配，为QEMU环境提供基本的OpenSBI接口（本项目中用于SD卡读写,网络包收发及串口输出）及payload（加载RT-Thread镜像）支持。

### 需实现内容

考虑到本次实验需利用起RISC-V的MMU（Machine态不使用MMU）并完成用户态的系统调用及上下文切换支持，需要将RT-Thread置于Supervisor态，在该态填充bss段，初始化MMU（sv39模式）、时钟中断并建立用户态执行环境，然后执行流移交给RT-Thread通用的shell等用户态程序。

由于用户态将与内核态处于不同的特权级，需要为用户态实现一套系统调用框架并自行设计支持几个简单系统调用以验证设计正确性。

为更有效展示RT-Thread组件功能，还需为本RISC-V virt机型适配一些外设，以便验证较为复杂组件的可用性，确保基础组件实现正确性。

## 时间规划

### 原计划

7月20日-26日：搭建BBL测试环境，确保能够在QEMU上启动到Supervisor态并启动MMU

7月27日-8月2日：编写Supervisor态中断处理代码，确保能够执行到RT-Thread的调度器。如时间允许，编写上下文切换代码（含用户态支持）。

8月3日-9日：确保上下文切换代码无问题，开始实验文件系统支持。

8月10日-30日：另有安排，与外设适配相关的其他项目，可积累外设适配经验。

8月31日-9月6日：文件系统适配

9月7日-20日：LCD等外设适配

9月21日-30日：可能的外设适配收尾，代码整理、详细文档书写。

## 当前进度

已经按照沟通结果完成设计目标。实现细节如下。

### 实现细节

#### 启动

Das U-boot是一个开源的bootloader，其支持从存储设备加载操作系统镜像并启动。利用createimage工具将编译后的rtthread.elf中二进制部分抽出和单独编译的bootblock整合（bootblock在前）作为磁盘镜像。则启动时磁盘第一个扇区（512B）可以被U-boot自动加载到0x10200000地址并由此以supervisor态开始执行。在进入supervisor态后，我们可以使用OpenSBI接口调用U-boot的函数读取磁盘上数据。

bootblock使用上述OpenSBI接口从虚拟SD卡读取rtthread.elf中全部内容到0x10201000并跳转到该地址，由此正式进入RT-Thread部分。

RT-Thread启动时清空BSS段并初始化一些特权寄存器，关闭FPU，允许Supervisor态访问用户态虚存，初始化MMU、syscall跳转表、用户态内存池、uart、SD卡驱动、网卡驱动、时钟中断、输出设备、heap，然后进入通用部分。

##### MMU初始化

MMU部分使用sv39模式，为简化系统启动流程，内核部分的所有地址在开启MMU前后保持不变（虚地址与实地址一一对应）。用户态使用虚地址中较高一半编码空间。初始化中需要正确设置页表起始地址并开启MMU，清空指令cache和TLB。在risc-v体系结构下TLB随后由硬件管理，不再需要手工干预。

##### syscall初始化

在中断处理中，若检测到中断原因为用户态的syscall，则根据syscall编号调用相应函数完成处理后返回。此处最简单的解决方式为一包含处理函数地址的数组。

##### 用户态内存池初始化

目前RT-Thread中未提供分配4K对齐地址的内存分配器，故我自行实现了一个固定分配4K大小4K对齐内存地址的分配器供用户态相关组件使用。

#### 进程初始化

为支持用户态+虚存的模式，进程的PCB需要添加一项PGDIR纪录，指示其页表入口地址，在随后的context switch过程中将完成实际的页表切换。由于尚未实现文件系统机制，用户态程序目前以ELF格式的payload形式打包存放在一数组内，用户态进程初始化时将其中的有效部分提取到预先分配的内核虚地址（与物理地址实质等同）并与用户态虚地址建立映射。用户态栈地址（虚地址）处同样预先分配内核虚地址并建立用户态虚地址的映射。原初始化参数中的进程入口地址对用户态进程不再有意义，因而为用户态统一设置，忽略传入参数。类似地，进程初始化时虽然ra设置为内核态的exit函数地址，但因特权级限制实际永远不会使用。

为支持原有运行于特权态的进程（如msh），对内核进程不搬移相关数据，PGDIR项设置为内核统一的PGDIR。

#### 用户态程序设计

本次实现使用了我个人操作系统实验课中使用的微型C库。其在进入用户态main函数前仅会设置gp寄存器值。在main函数退出后调用sys_exit以通知操作系统结束进程，随后进入死循环（正常情况下不会进入）。

#### 进程退出

调用者轨迹：用户态syscall->syscall handler->rt\_thread\_exit。用户态进程需要遍历其页表回收全部用户态内存。

#### 中断处理

中断处理目前主要为三个目的服务：系统调用、时钟中断和串口输入。

系统调用前文已有叙述。

时钟中断时，处理器自动进入配置好的中断处理入口，保存现场后进入C编写的中断处理函数。此处根据tick重设时钟比较寄存器。由于串口输入的SBI接口不支持中断，在此处尝试调用SBI call以获取输入是改动较小的一种workaround。此外，时钟中断还作为调度条件，每次遇到时钟中断即进行调度。

#### MISC

为支持任务目标，在汇编部分还实现了一些零散功能如下：

* 将所有machine态csr设置指令替换为supervisor态csr设置指令
* 在context switch from进程保存完毕，to进程开始恢复前，切换pgdir
* 判断切换到进程特权级，确定sret后特权态。

中期后修复的bug：context switch过程中异常与普通栈混用问题、第一个用户态进程的初始化工作被略过问题、通用组件与体系结构相关组件混合问题。

本适配在用户态使用的C库在现有实现条件下支持的功能包括不限于：字符串处理、字符输出、程序退出。如后续为RT-Thread补全系统调用机制则可以较为自然地支持sleep、用户态线程间同步原语、文件管理等复杂功能(用户态C库可在UCAS-Core操作系统完成上述功能)。

未能实现的功能：LCD外设支持。由于当前QEMU对RISC-V机型支持特别是外设支持有限，尚无法为QEMU加入LCD外设支持（Linux RISC-V版在QEMU上同样用nographic方式启动）。导师曾推荐尝试semihosting模式，但经调查发现，RISC-V的semihosting支持今年才有相关patch且仅适用于RV32，考虑到当前适配条件，无法引入。

## 总结

本次开源供应链点亮计划让我得以有机会近距离接触长久以来都很感兴趣的RTOS领域。通过自己为RT-Thread添加更完善的RISC-V支持，我对RT-Thread整体设计有了较为深刻的了解，通过为其添加RISC-V相关支持，我对RISC-V的特权态相关内容也掌握得更加熟练，这对我的一生一芯任务目标-在自己设计的RISC-V处理器核上启动RT-Thread也有着很大的帮助。

虽然SUMMER 2020活动即将结束，但这应当只是我与RT-Thread的初次相遇，期待在不远的将来可以在我的处理器核上看到RT-Thread的活跃身影，也期待未来有机会为RT-Thread做一些进一步的贡献。